name: Clean feature request prefixes from discussion titles

on:
  discussion:
    types: [created, edited]

permissions:
  discussions: write

jobs:
  clean-title:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clean discussion title
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const currentTitle = context.payload.discussion.title;
            
            // Define patterns to remove (case-insensitive)
            const patterns = [
              /^\[?FR\]?:?\s*/i,
              /^\[?Feature\s*[Rr]equest\]?:?\s*/i,
              /^Feature\s*[Rr]equest:?\s*/i,
              /^\[?FR\s*-\s*/i,
              /^\[?Feature\]?:?\s*/i,
            ];
            
            let cleanedTitle = currentTitle;
            
            // Apply each pattern
            for (const pattern of patterns) {
              cleanedTitle = cleanedTitle.replace(pattern, '');
            }
            
            // Trim any leading/trailing whitespace
            cleanedTitle = cleanedTitle.trim();
            
            // Only update if the title changed and is not empty
            if (cleanedTitle !== currentTitle && cleanedTitle.length > 0) {
              console.log(`Original title: "${currentTitle}"`);
              console.log(`Cleaned title: "${cleanedTitle}"`);
              
              try {
                await github.graphql(`
                  mutation($discussionId: ID!, $title: String!) {
                    updateDiscussion(input: {
                      discussionId: $discussionId,
                      title: $title
                    }) {
                      discussion {
                        id
                        title
                      }
                    }
                  }
                `, {
                  discussionId: context.payload.discussion.node_id,
                  title: cleanedTitle
                });
                
                console.log('Title updated successfully');
              } catch (error) {
                console.error('Failed to update discussion title:', error.message);
              }
            } else {
              console.log('No changes needed to the title');
            }
